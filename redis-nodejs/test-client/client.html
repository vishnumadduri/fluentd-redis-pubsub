<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
            
              $($("input[id=formButton]")).click(function(){
                var userId = $('#idForm').find('input[name="userId"]').val();
                $('#idForm').hide(500);

                // push notifications stuff------------------------------------
                //connect to the socket
                var socket = io.connect('http://127.0.0.1:8001/notifications');
                $("#messages").append('<li>Connecting...</li>');
                
                var dict = new Map();


             
                //Redis notification receiver
                socket.on('notification', function (channel, notification) {
                  var payload = JSON.parse(notification);

                  // console.log(channel + ': ' + JSON.stringify(payload));

                  if(dict.has(payload.did)){
                    var previousreading=dict.get(payload.did);

                    var y1=parseFloat(previousreading.accel.y);
                    var y2=parseFloat(payload.accel.y);

                    var x1=parseFloat(previousreading.accel.x);
                    var x2=parseFloat(payload.accel.x);

                    console.log('e:'+JSON.stringify(payload) + 'p '+JSON.stringify(previousreading))
                    // console.log(channel + ': existing' + payload.did + 'top :' + (previousreading.accel.y+payload.accel.y) + '  left : '+(x1+x2));
                    $("#"+payload.did).offset({top: previousreading.accel.y+payload.accel.y, left: previousreading.accel.x+payload.accel.x});
                    dict.set(payload.did,payload);


                  }else{
                    dict.set(payload.did,payload);
                    console.log(channel + ': added ' + payload.did);
                    jQuery('<div/>', {
                     text: payload.did,
                     id: ''+payload.did,
                     style:"  border: 2px solid #73AD21;height:100px;width:100px;position:absolute;",
                     title: 'now this div has a title!'
                  }).appendTo('#mySelector');


                  }

                });

                //Connection confirmation
                socket.on('connected', function () {
                  var msg = "You are now connected for push notifications";
                  console.log(msg);
                  $("#messages").append('<li>'+msg+'</li>');
                  // Send the user ID
                  socket.emit('join', userId);
                });
                // End push notifications stuff---------------------------------
               return false;
              });
        });
        </script>
    </head>
    <body>
        <form id="idForm" action="">
          User ID: <input type="text" name="userId"><br>
          <input id="formButton" type="submit" value="Submit">
        </form> 
        <h2>Messages from server:</h2>
        <ul id="messages">
        </ul>
        <div id="mySelector">

        </div>
    </body>
<html>